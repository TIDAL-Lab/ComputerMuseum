<!DOCTYPE html> 
<html> 
<head> 
   <title>Computer History Museum</title>
   <meta name="apple-mobile-web-app-capable" content="yes">
   <meta name="viewport" content="initial-scale=1.0,  maximum-scale=1.0, user-scalable=no">
   <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">   
   <link rel="stylesheet" href="code.css">
   
   <script type="text/javascript" src="blockly/blockly_compressed.js"></script>
   <script type="text/javascript" src="blockly/language/en/_messages.js"></script>
   <script type="text/javascript" src="language.js"></script>
   <script type="text/javascript" src="blockly/generators/javascript.js"></script>   
   <script type="text/javascript" src="generator.js"></script>
   <script type="text/javascript">
      
   
   var frog_color = 4;
   var frog_pattern = "dots";
   
   //---------------------------------------------------------------------------
   // Utility functions
   //---------------------------------------------------------------------------
   function setHtmlVisibility(id, visible) {
      var el = document.getElementById(id);
      if (el) {
         el.style.visibility = visible ? "visible" : "hidden";
      }
   }
   
   
   function setHtmlOpacity(id, opacity) {
      var el = document.getElementById(id);
      if (el) {
         if (opacity > 0) {
            el.style.zIndex = 100;
         } else {
            el.style.zIndex = -1;
         }
         el.style.opacity = opacity;
      }
   }
   
   
   function fadeOutAfterDelay(id, delay) {
      window.setTimeout(function() { setHtmlOpacity(id, 0.0); }, delay);
   }
   
   
   //---------------------------------------------------------------------------
   // Attempt to open a web socket connection to communicate with the frog pond
   //---------------------------------------------------------------------------
   var socket = null;
   if ("WebSocket" in window) {
      var host = window.location.hostname;
      socket = new WebSocket("ws://" + host + ":8887");
      socket.onopen    = function(evt) { console.log("connected."); }
      socket.onmessage = function(evt) { processEvent(evt.data); }
      socket.onerror   = function(evt) { console.log("error in server connection"); }
      socket.onclose   = function(evt) { console.log("server connection closed."); }
   }
   
   // simulation is playing
   var playing = false;
   
   Blockly.addChangeListener(function () {
      alert("change");
   });
   
   
   //---------------------------------------------------------------------------
   // Broadcast a message
   //---------------------------------------------------------------------------
   function sendMessage(message) {
      if (socket != null && socket.readyState == 1) {
         socket.send('@dart ' + message);
      }
   }

   
   //---------------------------------------------------------------------------
   // Process dart event
   //---------------------------------------------------------------------------
   function processEvent(event) {
      var button = document.getElementById("play-button");
      if (event == "@blockly DONE" ||
          event == "@blockly RESTARTED" ||
          event == "@blockly PAUSED") {
         button.style.backgroundImage = 'url("images/play.png")';
         playing = false;
      }
      else if (event == "@blockly STARTED") {
         button.style.backgroundImage = 'url("images/pause.png")';
         playing = true;
      }
   }


   //---------------------------------------------------------------------------
   // Play / pause the simulation
   //---------------------------------------------------------------------------
   function playPause() {
      if (playing) {
         sendMessage("PAUSE");
      } else {
         var code = Blockly.Generator.workspaceToCode('JavaScript');
         
         //--------------------------------------------------
         // error 1: no blocks on the screen
         //--------------------------------------------------
         if (code.length == 0) {
            setHtmlOpacity("hint1", 1.0);
            fadeOutAfterDelay("hint1", 4000);
         }
         
         //--------------------------------------------------
         // error 2: blocks aren't connected
         //--------------------------------------------------
         else if (code.indexOf("\n") >= 0) {
            setHtmlOpacity("hint2", 1.0);
            fadeOutAfterDelay("hint2", 4000);
         }
         
         else {
            var frog = "images/frog" + frog_color + "-" + frog_pattern + ".png";
            code = code.replace(/\]\[/g, '], [');
            sendMessage("PLAY (" + frog + ") " + code);
         }
      }
   }
   
   
   //---------------------------------------------------------------------------
   // Generate the color picker buttons
   //---------------------------------------------------------------------------
   function initColorPicker() {
      var colors = [
         'rgb(180, 12, 12)',
         'rgb(240, 108, 12)',
         'rgb(240, 180, 12)',
         'rgb(180, 200, 12)',
         'rgb(12, 180, 12)',
         'rgb(12, 166, 242)',
         'rgb(12, 70, 242)',
         'rgb(146, 12, 242)',
         'rgb(146, 12, 150)',
         'rgb(242, 12, 146)'
      ];
      var colorPicker = document.getElementById("color-picker");
      for (var c = 0; c < colors.length; c++) {
         var swatch = document.createElement("div");
         swatch.className = 'swatch';
         swatch.style.backgroundColor = colors[c];
         swatch.setAttribute("color-id", c);
         colorPicker.appendChild(swatch);
         swatch.onclick = function(event) {
           var f = document.getElementById("frog");
           f.setAttribute("style", "fill:" + this.style.backgroundColor);
           frog_color = this.getAttribute("color-id");
         };
      }
   }
   
   
   //---------------------------------------------------------------------------
   // callback to change the frog pattern
   //---------------------------------------------------------------------------
   function changeFrogPattern(pattern) {
      var f = document.getElementById("frog-pattern");
      f.setAttribute("fill", "url('images/frog.svg#" + pattern + "')");
      frog_pattern = pattern;
   }
   
   </script>

</head> 
<body onload="initColorPicker();">
   
   <!-- BLOCKLY CODE WINDOW -->
   <div id="frog-code" style="width: 750px; height: 650px;"></div>
   
   <xml id="toolbox" style="display: none">
      <block type="frogs_hop"></block>
      <block type="frogs_chirp"></block>
      <block type="frogs_turn"></block>
      <block type="frogs_turn_sound"></block>
      <block type="frogs_rest"></block>
      <block type="frogs_hatch"></block>
      <block type="frogs_die"></block>
      <block type="controls_wait"></block>
      <block type="controls_repeat"></block>
      <block type="controls_if"></block>
   </xml>
   
   <script type="text/javascript">
      Blockly.inject(document.getElementById('frog-code'),
                     { path: './blockly/',
                       toolbox: document.getElementById('toolbox') } );
   </script>
   
   
   <!-- POPUP HINT TEXT -->
   <img src="images/hint1.png" id="hint1" class="hint">
   <img src="images/hint2.png" id="hint2" class="hint">
      
      
   
   <!-- FROG INDICATOR -->
   <div id="frog-picker">
      <img src="images/customize.png">
   
      <!-- FROG SVG -->
      <div style="padding: 17px;">
         <svg xmlns="http://www.w3.org/2000/svg" height="125">
            <defs>
               <circle cx="30" cy="30" r="30" id="patt-circ"></circle>
            </defs>
            <use id="frog" xlink:href="images/frog.svg#frog-shape" fill="green" transform="scale(0.8, 0.8)"></use>
            <use id="frog-pattern" xlink:href="images/frog.svg#frog-shape" fill="url(images/frog.svg#dots)" transform="scale(0.8, 0.8)"></use>
         </svg>
      </div>
   
      <!-- COLOR PICKER -->
      <div id="color-picker"></div>
      
      
      <!-- PATTERN SELECTION -->
      <div class="pswatch" name="checks" onclick="changeFrogPattern(this.getAttribute('name'));">
         <svg xmlns="http://www.w3.org/2000/svg" height="60px">
            <use xlink:href="#patt-circ" fill="url(images/frog.svg#checks)"></use>
         </svg>
      </div>
      <div class="pswatch" name="stripes" onclick="changeFrogPattern(this.getAttribute('name'));">
         <svg xmlns="http://www.w3.org/2000/svg" height="60px">
            <use xlink:href="#patt-circ" fill="url(images/frog.svg#stripes)"></use>
         </svg>
      </div>
      <div class="pswatch" name="dots" onclick="changeFrogPattern(this.getAttribute('name'));">
         <svg xmlns="http://www.w3.org/2000/svg" height="60px">
            <use xlink:href="#patt-circ" fill="url(images/frog.svg#dots)"></use>
         </svg>
      </div>
   </div>

   <!-- TOOLBAR -->
   <div id="frog-toolbar">
      <div>
         <button id="restart-button" onclick="sendMessage('RESTART');"></button>
         <button id="play-button" onclick="playPause();"></button>
      </div>
   </div>
</body>
</html>